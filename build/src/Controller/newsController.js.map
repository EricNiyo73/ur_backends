{"version":3,"file":"newsController.js","names":["_express","_interopRequireDefault","require","_bodyParser","_newsModel","_multer","_nodemailer","_dotenv","_subscribers","_cloudinary","obj","__esModule","default","router","Router","path","dotenv","config","app","express","use","static","join","process","cwd","bodyParser","urlencoded","extended","json","cloudinary","cloud_name","env","CLOUDNAME","api_key","API_KEY","api_secret","API_SECRET","upload","multer","storage","diskStorage","fileFilter","req","file","cb","ext","extname","originalname","Error","error","exports","createNews","res","emailSubject","emailBody","transporter","nodemailer","createTransport","host","port","auth","user","EMAIL_USER","pass","EMAIL_PASS","tls","rejectUnauthorized","send","result","uploader","console","log","newNews","News","newsImage","secure_url","newsTitle","body","newsContent","category","saveNews","save","subscribedUsers","subscriber","find","forEach","mailOptions","from","to","email","subject","html","name","headers","sendMail","info","response","status","findAll","catName","query","cat","news","$in","data","err","getOne","findById","params","id","deleteNews","delete","updateNews","updatedNews","findByIdAndUpdate","new","_default"],"sources":["../../../src/Controller/newsController.js"],"sourcesContent":["// import router from \"express\".Router();\n// import { v4 as uuidv4 } from 'uuid';\nimport  Router  from 'express';\nconst router = Router();\nimport bodyParser from 'body-parser';\nimport News from \"../model/newsModel.js\";\nimport multer from \"multer\";\nconst path = require(\"path\");\nimport express from \"express\";\nimport nodemailer from \"nodemailer\";\nimport dotenv from 'dotenv';\nimport subscriber from '../model/subscribers.js';\ndotenv.config();\nconst app = express();\n// console.log(path.join(process.cwd(), \"/images\"));\nrouter.use(\"/images\", express.static(path.join(process.cwd(), \"/images\")));\nrouter.use(bodyParser.urlencoded({ extended: true }))\nrouter.use(bodyParser.json());\n\n// ============Claudinary configuration=================\nimport { v2 as cloudinary } from 'cloudinary';\ncloudinary.config({\n  cloud_name:process.env.CLOUDNAME,\n  api_key:process.env.API_KEY,\n  api_secret:process.env.API_SECRET\n});\nexport let upload = multer({\n  storage: multer.diskStorage({}),\n  fileFilter: (req, file, cb) => {\n    try {\n      let ext = path.extname(file.originalname);\n      if (ext !== \".JPG\" && ext !== \".JPEG\" && ext !== \".PNG\" && ext !== \".jpg\" && ext !== \".jpeg\" && ext !== \".png\"){\n        return cb(new Error(\"File type is not supported\"), false);\n      }\n      cb(null, true);\n    } catch (error) {\n      return cb(error, false);\n    }\n  },\n});\n// =============================Create a News=====================\nexport const createNews = async (req, res) => {\n  try {\n\n    // create a notification=============================\n    let emailSubject;\n    \n    let emailBody;\n    const transporter = nodemailer.createTransport({\n      host: \"smtp.gmail.com\",\n      port: 587,\n      auth: {\n        user: process.env.EMAIL_USER,\n        pass: process.env.EMAIL_PASS,\n      },\n      tls: {\n        rejectUnauthorized: false,\n      },\n    });\n    // ======================================================\n\n    if (!req.file) \n    return res.send('Please upload a file');\n    const result = await cloudinary.uploader.upload(req.file.path);\n    console.log(\"Request File: \", req.file);\n        const newNews = new News({\n          newsImage: result.secure_url,\n            newsTitle: req.body.newsTitle,\n            newsContent:req.body.newsContent,\n            category:req.body.category,\n          })\n          \n          const saveNews = await  newNews.save();\n          // ====================================================\n          const subscribedUsers = await subscriber.find();\n          emailSubject = \"New Update on UR Huye Site\";\n          emailBody = `<p>New News added on site !!!!!</p>`;\n        subscribedUsers.forEach((user) => {\n        const mailOptions = {\n          from: process.env.EMAIL_USER,\n          to: user.email,\n          subject: emailSubject,\n          html: `<p>Dear ${user.name},</p>${emailBody}\n          <a href=\"http://${req.headers.host}/news/\">Please click on the link to view the news</a>`,\n        };\n        transporter.sendMail(mailOptions, (error, info) => {\n          if (error) {\n            console.error(error);\n          } else {\n            console.log(\"Email sent: \" + info.response);\n          }\n        });\n      });\n\n          // ===================================================================\n         return res.status(200).json({\n            saveNews,\n             status: \"your news was successfully uploaded\"});\n             \n      } catch (error) {\n        return  res.status(500).json(error)\n          \n      }\n  }\n\n  // =====================get All news======================\n\n  export const findAll = async (req, res) => {\n    const catName = req.query.cat;\n    try {\n      let news;\n       if (catName) {\n        news = await News.find({\n          category: {\n            $in: [catName],\n          },\n        });\n      } else {\n        news = await News.find();\n      }\n      return res.status(200).json({\n        data: news\n      });\n      \n    } catch (err) {\n      return res.status(500).json(err);\n    }\n  };\n  // export const findAll = async (req, res) => {\n  //   try{\n  //   const news = await News.find();\n      \n  //     return res.status(200).json({\n  //       data: news\n  //     });\n  //   } catch (err) {\n  //     return res.status(500).json(err);\n  //   }\n  // };\n\n  // =====================get One news================================\n  export const getOne = async (req, res) => {\n    try {\n      const news = await News.findById(req.params.id);\n      return res.status(200).json(news);\n    } catch (err) {\n      return res.status(500).json(err);\n    }\n  };\n  // ======================Delete==============================\n  export const deleteNews = async (req, res) => {\n    try {\n      const news = await News.findById(req.params.id);\n        try {\n          await news.delete();\n          return res.status(200).json(\"news has been deleted...\");\n        } catch (err) {\n          return  res.status(500).json(err);\n        }\n    } catch (err) {\n      return res.status(500).json(err);\n    }\n  };\n\n  // ===============Update=============================\n  export const updateNews = async (req, res) => {\n    try {\n      // const { id } = req.params;\n      const result = await cloudinary.uploader.upload(req.file.path);\n      const updatedNews = await News.findByIdAndUpdate(\n        req.params.id,\n        {\n          newsTitle: req.body.newsTitle,\n          newsContent: req.body.newsContent,\n          category: req.body.category,\n          newsImage: result.secure_url\n        },\n        { new: true } \n      );\n  \n      if (!updatedNews) {\n        return res.status(404).json({ error: \"News not found\" });\n      }\n  \n      return res.status(200).json({\n        updatedNews,\n        status: \"Your news was successfully  updated\",\n      });\n    } catch (error) {\n      return res.status(500).json(error);\n    }\n  };\n\n\n\n  \n  \nexport default router;"],"mappings":"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"}